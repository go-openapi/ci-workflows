name: Contributors

permissions:
  contents: read

on:
  workflow_call:
    inputs:
      enable-commit-signing:
        description: |
          Enable GPG commit signing by a bot user.

          When enabled, commits in the pull request will be signed with the bot's GPG key.
        required: false
        type: boolean
        default: true
    secrets:
      github-app-id:
        description: |
          GitHub App ID for bot user authentication.

          Default for go-openapi: CI_BOT_APP_ID

          Required to create pull requests as the bot user.
        required: false
      github-app-private-key:
        description: |
          GitHub App private key in PEM format.

          Default for go-openapi: CI_BOT_APP_PRIVATE_KEY

          Required to create pull requests as the bot user.
        required: false
      gpg-private-key:
        description: |
          GPG private key in armored format for signing commits.

          Default for go-openapi: CI_BOT_GPG_PRIVATE_KEY

          Required when enable-commit-signing is true.
        required: false
      gpg-passphrase:
        description: |
          Passphrase to unlock the GPG private key.

          Default for go-openapi: CI_BOT_GPG_PASSPHRASE

          Required when enable-commit-signing is true.
        required: false
      gpg-fingerprint:
        description: |
          Fingerprint of the GPG signing key (spaces removed).

          Default for go-openapi: CI_BOT_SIGNING_KEY

          Required when enable-commit-signing is true.
        required: false

jobs:
  update-contributors:
    name: all-time contributors
    permissions:
      pull-requests: write
      contents: write
    runs-on: ubuntu-latest
    outputs:
      pull-request-url: ${{ steps.create-pull-request.outputs.pull-request-url }}
    steps:
      -
        name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      -
        name: Identify all-time contributors to this repository
        uses: github/contributors@e345de71bbd056a34a70709afd4f4bf0a270cc1a # v1.7.7
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPOSITORY:  ${{ github.repository }}
          LINK_TO_PROFILE: 'True'
      -
        name: Rename contributor file
        run: |
          rm -rf contributors.json
          mv contributors.md CONTRIBUTORS.md
      -
        name: Configure bot credentials
        uses: go-openapi/gh-actions/ci-jobs/bot-credentials@6c7952706aa7afa9141262485767d9270ef5b00b # master
        id: bot-credentials
        # For go-openapi repos (using secrets: inherit):
        #   Falls back to: CI_BOT_APP_ID, CI_BOT_APP_PRIVATE_KEY, CI_BOT_GPG_PRIVATE_KEY, etc.
        #
        # For other orgs: explicitly pass secrets with your custom names
        with:
          enable-github-app: 'true'
          github-app-id: ${{ secrets.github-app-id || secrets.CI_BOT_APP_ID }}
          github-app-private-key: ${{ secrets.github-app-private-key || secrets.CI_BOT_APP_PRIVATE_KEY }}
          enable-gpg-signing: ${{ inputs.enable-commit-signing }}
          gpg-private-key: ${{ secrets.gpg-private-key || secrets.CI_BOT_GPG_PRIVATE_KEY }}
          gpg-passphrase: ${{ secrets.gpg-passphrase || secrets.CI_BOT_GPG_PASSPHRASE }}
          gpg-fingerprint: ${{ secrets.gpg-fingerprint || secrets.CI_BOT_SIGNING_KEY }}
          enable-commit-signing: 'true'
          enable-tag-signing: 'false'
      -
        name: Create a PR
        id: create-pull-request
        uses: peter-evans/create-pull-request@98357b18bf14b5342f975ff684046ec3b2a07725 # v8.0.0
        with:
          commit-message: "doc: updated contributors file"
          branch: doc/contributors-bot
          delete-branch: true
          title: "doc: updated contributors file"
          token: ${{ steps.bot-credentials.outputs.app-token }}
          labels: "bot"
          draft: false
          assignees: fredbi
          reviewers: fredbi
          sign-commits: ${{ inputs.enable-commit-signing }}
          signoff: true # DCO

  auto-merge:
    # description: |
    #   Validates and merge the pull request triggered above.
    needs: [update-contributors]
    permissions:
      contents: write
      pull-requests: write
    runs-on: ubuntu-latest
    env:
      PR_URL: ${{needs.update-contributors.outputs.pull-request-url}}
      GH_TOKEN: ${{secrets.GITHUB_TOKEN}}
    steps:
      -
        name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      -
        name: Auto-approve PR
        run: gh pr review --approve "$PR_URL"
      # The approval event normally kicks regular workflows, in particular the auto-merge workflow.
      # So there is no need to merge here. Explicit merging was initially added because this
      #-
      #  name: Wait for all workflow runs to complete
      #  uses: go-openapi/gh-actions/ci-jobs/wait-pending-jobs@55bd46a7224dc61a7b8e64df6d3755b1cf986fba # v1.2.0
      #  with:
      #    pr-url: ${{ env.PR_URL }}
      #    github-token: ${{ secrets.GITHUB_TOKEN }}
      #-
      #  name: Auto-merge PR
      #  run: gh pr merge --auto --rebase "$PR_URL"
