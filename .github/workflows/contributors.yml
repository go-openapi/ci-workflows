name: Contributors

permissions:
  contents: read

on:
  workflow_call:
    inputs:
      enable-commit-signing:
        description: |
          Enable GPG commit signing by a bot user.

          When enabled, commits in the pull request will be signed with the bot's GPG key.
        required: false
        type: string
        default: "true"
    secrets:
      github-app-id:
        description: |
          GitHub App ID for bot user authentication.

          Default for go-openapi: CI_BOT_APP_ID

          Required to create pull requests as the bot user.
        required: false
      github-app-private-key:
        description: |
          GitHub App private key in PEM format.

          Default for go-openapi: CI_BOT_APP_PRIVATE_KEY

          Required to create pull requests as the bot user.
        required: false
      gpg-private-key:
        description: |
          GPG private key in armored format for signing commits.

          Default for go-openapi: CI_BOT_GPG_PRIVATE_KEY

          Required when enable-commit-signing is true.
        required: false
      gpg-passphrase:
        description: |
          Passphrase to unlock the GPG private key.

          Default for go-openapi: CI_BOT_GPG_PASSPHRASE

          Required when enable-commit-signing is true.
        required: false
      gpg-fingerprint:
        description: |
          Fingerprint of the GPG signing key (spaces removed).

          Default for go-openapi: CI_BOT_SIGNING_KEY

          Required when enable-commit-signing is true.
        required: false

jobs:
  update-contributors:
    name: all-time contributors
    permissions:
      pull-requests: write
      contents: write
    runs-on: ubuntu-latest
    outputs:
      pull-request-url: ${{ steps.create-pull-request.outputs.pull-request-url }}
      pull-request-operation: ${{ steps.create-pull-request.outputs.pull-request-operation }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - name: Identify all-time contributors to this repository
        uses: github/contributors@e5629ec91f6ed85ebf9d145b17f9f2bd7ed324af # v2.0.1
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPOSITORY: ${{ github.repository }}
          LINK_TO_PROFILE: "True"
      - name: Rename contributor file
        run: |
          rm -rf contributors.json
          mv contributors.md CONTRIBUTORS.md
      - name: Configure bot credentials
        uses: go-openapi/gh-actions/ci-jobs/bot-credentials@23cdaeff454807ac293a6e98cff552a2ea49be63 # v1.4.7
        id: bot-credentials
        # For go-openapi repos (using secrets: inherit):
        #   Falls back to: CI_BOT_APP_ID, CI_BOT_APP_PRIVATE_KEY, CI_BOT_GPG_PRIVATE_KEY, etc.
        #
        # For other orgs: explicitly pass secrets with your custom names
        with:
          enable-github-app: "true"
          github-app-id: ${{ secrets.github-app-id || secrets.CI_BOT_APP_ID }}
          github-app-private-key: ${{ secrets.github-app-private-key || secrets.CI_BOT_APP_PRIVATE_KEY }}
          enable-gpg-signing: ${{ inputs.enable-commit-signing }}
          gpg-private-key: ${{ secrets.gpg-private-key || secrets.CI_BOT_GPG_PRIVATE_KEY }}
          gpg-passphrase: ${{ secrets.gpg-passphrase || secrets.CI_BOT_GPG_PASSPHRASE }}
          gpg-fingerprint: ${{ secrets.gpg-fingerprint || secrets.CI_BOT_SIGNING_KEY }}
          enable-commit-signing: "true"
          enable-tag-signing: "false"
      - name: Create a PR
        id: create-pull-request
        uses: peter-evans/create-pull-request@c0f553fe549906ede9cf27b5156039d195d2ece0 # v8.1.0
        with:
          commit-message: "doc: updated contributors file"
          branch: doc/contributors-bot
          delete-branch: true
          title: "doc: updated contributors file"
          token: ${{ steps.bot-credentials.outputs.app-token }}
          labels: "bot"
          draft: false
          assignees: fredbi
          reviewers: fredbi
          sign-commits: ${{ inputs.enable-commit-signing }}
          signoff: true # DCO

  no-change:
    needs: [update-contributors]
    runs-on: ubuntu-latest
    if: ${{ needs.update-contributors.outputs.pull-request-operation  == 'none' }}
    steps:
      - name: Report no change needed
        run: |
          echo "::notice title=no-change::No change needed to the contributors file"
          exit 0

  auto-merge:
    # description: |
    #   Approves the PR, waits for all jobs (including non-required ones), and enables auto-merge.
    #
    #   This workflow completes the full auto-merge flow for bot-created PRs:
    #   1. Approve the PR (bot can't approve its own PR)
    #   2. Wait for all workflow runs to complete (prevents branch deletion during non-required jobs)
    #   3. Enable auto-merge if not already enabled (avoids race condition with auto-merge.yml)
    needs: [update-contributors]
    permissions:
      contents: write
      pull-requests: write
    runs-on: ubuntu-latest
    if: ${{ needs.update-contributors.outputs.pull-request-operation  != 'none' }}
    env:
      PR_URL: ${{ needs.update-contributors.outputs.pull-request-url }}
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - name: Auto-approve PR
        run: gh pr review --approve "$PR_URL"
      - name: Wait for all workflow runs to complete
        uses: go-openapi/gh-actions/ci-jobs/wait-pending-jobs@23cdaeff454807ac293a6e98cff552a2ea49be63 # v1.4.7
        with:
          pr-url: ${{ env.PR_URL }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Enable auto-merge
        run: |
          # Attempt to enable auto-merge, handling race condition gracefully
          set +e  # Don't exit on error
          OUTPUT=$(gh pr merge --auto --rebase "$PR_URL" 2>&1)
          EXIT_CODE=$?
          set -e  # Re-enable exit on error

          if [ $EXIT_CODE -eq 0 ]; then
            echo "::notice title=auto-merge::Auto-merge enabled successfully"
            exit 0
          fi

          # Check if error is due to race condition (merge already in progress)
          # GitHub GraphQL API returns: "GraphQL: Merge already in progress (mergePullRequest)"
          if echo "$OUTPUT" | grep -q "Merge already in progress"; then
            echo "::warning title=auto-merge::Auto-merge already handled by another workflow (race condition)"
            exit 0
          fi
          if echo "$OUTPUT" | grep -q "Pull request is already merged"; then
            echo "::warning title=auto-merge::Auto-merge already handled by another workflow (race condition)"
            exit 0
          fi

          # Unexpected error - fail the workflow
          echo "::error title=auto-merge::Failed to enable auto-merge"
          echo "$OUTPUT"
          exit $EXIT_CODE
